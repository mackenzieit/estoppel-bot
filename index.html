<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Estoppel Letter Bot</title>

    <!-- OpenAI domain verification: keep YOUR real key -->
    <meta name="openai-domain-verification"
          content="domain_pk_691015c34964819095aeddb3c4acdb270004168287797164" />

    <!-- ChatKit SDK (from the docs). Use DEFER, not async, so it loads before init
    <script src="https://cdn.platform.openai.com/deployments/chatkit/chatkit.js?v=2" defer></script>
        <script src="https://cdn.platform.openai.com/deployments/chatkit/chatkit.js" defer></script>
    -->
    
    <script src="https://cdn.platform.openai.com/deployments/chatkit/chatkit.js?v=2" defer></script>

    <style>
      html, body { height:100%; margin:0; background:#f9fafb; color:#1e293b;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
      @media (prefers-color-scheme: dark) { body { background:#0f172a; color:#e2e8f0; } }
      #chat { height:100vh; width:100vw; display:flex; align-items:center; justify-content:center; }
      .loading { font-size:1.1rem; opacity:.7; }
      #err { position:fixed; left:12px; bottom:12px; font:12px/1.4 monospace; color:#b91c1c; }
    </style>
  </head>
  <body>
    <div id="chat"><div class="loading">Loading Estoppel Letter Bot...</div></div>
    <div id="err"></div>

    <script>
      // Robust initializer: handles different globals & timing
      (function () {
        const container = document.getElementById("chat");
        const showErr = (msg) => { document.getElementById("err").textContent = msg; console.error(msg); };

        function getSdk() {
          // different builds expose different globals
          return window.ChatKit || window.chatkit || window.OpenAIChat || null;
        }

        function start() {
          const sdk = getSdk();
          if (!sdk || typeof sdk.open !== "function") return false;

          // support both snake_case and camelCase just in case
          const cfg = {
            workflow_id: "wf_690bb1d11a1c8190adcb640e789dc71508144f38704a106c",
            workflowId:  "wf_690bb1d11a1c8190adcb640e789dc71508144f38704a106c",
            version: "1",
            theme: "light",
            container
          };

          try {
            sdk.open(cfg);
            return true;
          } catch (e) {
            showErr("ChatKit open() error: " + (e && e.message ? e.message : e));
            return true; // stop retrying; we reached SDK but it threw
          }
        }

        // Wait until the script really attached the global
        function waitForSdk(tries = 0) {
          if (start()) return; // success or handled error

          if (tries > 60) { // ~12s total
            showErr("ChatKit SDK never initialized. Check the script URL and domain allowlist.");
            return;
          }
          setTimeout(() => waitForSdk(tries + 1), 200);
        }

        // Run after DOM is ready (the SDK has 'defer', so it should be ready soon after)
        document.addEventListener("DOMContentLoaded", () => waitForSdk());
      })();
    </script>
  </body>
</html>
